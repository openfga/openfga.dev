# .github/workflows/preview.yml
name: Deploy PR previews
permissions:
  contents: read
concurrency:
  group: preview-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
      - closed

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    if: |
      github.actor != 'dependabot[bot]' &&
      github.event.pull_request.draft == false &&
      github.event.pull_request.head.repo.full_name == github.repository
    permissions:
      contents: write # Required for pr-preview-action to push to gh-pages
      pull-requests: write # Required for PR comments
    steps:
      - name: Cached LFS checkout
        uses: nschloe/action-cached-lfs-checkout@f46300cd8952454b9f0a21a3d133d4bd5684cfc2

      - name: Set up node
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build website
        run: npm run build
        env:
          BASE_URL: /pr-preview/pr-${{ github.event.number }}

      - name: Deploy preview
        uses: rossjrw/pr-preview-action@3e4ed158ecbf7f58513abc0dc15a4ad3b0e18ee5
        id: preview-step
        with:
          source-dir: ./build/

      - name: Publish preview link to job summary
        if: steps['preview-step'].outputs['deployment-action'] == 'deploy'
        run: |
          url="${{ steps['preview-step'].outputs['preview-url'] }}"
          echo "Preview visible at ${url}" >> "$GITHUB_STEP_SUMMARY"
          echo "[Open preview](${url})" >> "$GITHUB_STEP_SUMMARY"
